Ext.define("AddressBook.view.GridFilters",{extend:"Ext.plugin.Abstract",requires:["Ext.grid.filters.filter.*"],mixins:["Ext.util.StoreHolder"],alias:"plugin.gfilters",pluginId:"gfilters",defaultFilterTypes:{"boolean":"boolean","int":"number",date:"date",number:"number"},filterCls:Ext.baseCSSPrefix+"grid-filters-filtered-column",menuFilterText:"Filters",showMenu:true,stateId:undefined,init:function(b){var c=this,a,d;c.grid=b;b.filters=c;if(c.grid.normalGrid){c.isLocked=true}b.clearFilters=c.clearFilters.bind(c);a=b.store;d=b.headerCt;b.on({scope:c,destroy:c.onGridDestroy,beforereconfigure:c.onBeforeReconfigure,reconfigure:c.onReconfigure});c.bindStore(a);if(b.stateful){a.statefulFilters=true}c.initColumns()},initColumns:function(){var a=this.grid,m=a.getStore(),d=a.columnManager.getColumns(),k=d.length,h,c,b,g,f;var l=this;var j=[];for(h=0;h<k;h++){c=d[h];b=c.filter;if(b&&!b.isGridFilter){if(!g){g=m.getFilters();g.beginUpdate()}this.createColumnFilter(c);c.filter.createMenu();j.push({text:c.text,checked:false,menu:c.filter.menu,filter:c.filter,listeners:{scope:l,checkchange:l.onCheckChange,activate:l.onBeforeActivate}})}}var e=a.down("toolbar");e.insert(0,{xtype:"splitbutton",text:"",iconCls:null,glyph:AddressBook.util.Glyphs.getGlyph("filter"),menu:j,handler:"onClearFilters",scope:l});if(g){g.endUpdate()}},onClearFilters:function(){this.clearFilters()},createColumnFilter:function(e){var f=this,a=e.filter,d={column:e,grid:f.grid,owner:f},g,b,c;if(Ext.isString(a)){d.type=a}else{Ext.apply(d,a)}if(!d.type){b=f.store.getModel();g=b&&b.getField(e.dataIndex);c=g&&g.type;d.type=(c&&f.defaultFilterTypes[c])||e.defaultFilterType||"string"}e.filter=Ext.Factory.gridFilter(d)},onAdd:function(d,c,a){var b=c.filter;if(b&&!b.isGridFilter){this.createColumnFilter(c)}},onMenuCreate:function(b,a){a.on({beforeshow:this.onMenuBeforeShow,scope:this})},onMenuBeforeShow:function(f){var d=this,c,b,e,a;if(d.showMenu){if(!d.menuItems){d.menuItems={}}e=f.up("grid");a=e.id;c=d.menuItems[a];if(!c||c.isDestroyed){c=d.createMenuItem(f,a)}d.activeFilterMenuItem=c;b=d.getMenuFilter(e.headerCt);if(b){b.showMenu(c)}c.setVisible(!!b);d.sep.setVisible(!!b)}},createMenuItem:function(d,a){var c=this,b;c.sep=d.add("-");b=d.add({checked:false,itemId:"filters",text:c.menuFilterText,listeners:{scope:c,checkchange:c.onCheckChange}});return(c.menuItems[a]=b)},onGridDestroy:function(){var c=this,a=c.menuItems,b;c.bindStore(null);c.sep=Ext.destroy(c.sep);for(b in a){a[b].destroy()}c.grid=null},onUnbindStore:function(a){a.getFilters().un("remove",this.onFilterRemove,this)},onBindStore:function(a,b,c){this.local=!a.getRemoteFilter();a.getFilters().on("remove",this.onFilterRemove,this)},onFilterRemove:function(h,f){var b=f.items.length,a=this.grid.columnManager,c,e,g,d;for(c=0;c<b;c++){e=f.items[c];g=a.getHeaderByDataIndex(e.getProperty());if(g){d=g.filter;if(!d||!d.menu||e.getId().indexOf(d.getBaseIdPrefix())===-1){continue}if(!d.preventFilterRemoval){d.onFilterRemove(e.getOperator())}}}},getMenuFilter:function(a){return a.getMenu().activeHeader.filter},onBeforeActivate:function(a,b){this.activeFilterMenuItem=a;this.activeFilterMenuItem.activeFilter=a.filter},onCheckChange:function(c,d){var a=this.isLocked?c.up("grid"):this.grid,b=c.filter;b.setActive(d)},getHeaders:function(){return this.grid.view.headerCt.columnManager.getColumns()},isStateful:function(){return this.grid.stateful},addFilter:function(c){var h=this,a=h.grid,k=h.store,d=false,l=true,j,e,f,g,b,m;if(!Ext.isArray(c)){c=[c]}for(f=0,g=c.length;f<g;f++){b=c[f];j=b.dataIndex;e=a.columnManager.getHeaderByDataIndex(j);if(e){d=true;if(b.value){l=false}m=e.filter;if(m&&m.isGridFilter){m.deactivate();m.destroy();if(h.activeFilterMenuItem){h.activeFilterMenuItem.menu=null}}e.filter=b}}if(d){k.suppressNextFilter=l;h.initColumns();k.suppressNextFilter=false}},addFilters:function(a){if(a){this.addFilter(a)}},clearFilters:function(b){var a=this.grid,e=a.columnManager.getColumns(),k=a.store,j=k.getAutoFilter(),d,c,g,h,f;if(b!==undefined){k.setAutoFilter(b)}for(g=0,h=e.length;g<h;g++){d=e[g];c=d.filter;if(c&&c.isGridFilter){if(!f){f=k.getFilters();f.beginUpdate()}c.setActive(false)}}if(f){f.endUpdate()}if(b!==undefined){k.setAutoFilter(j)}},onBeforeReconfigure:function(c,a,b){if(a){a.getFilters().beginUpdate()}this.reconfiguring=true},onReconfigure:function(c,a,b,e){var d=this;if(a&&e!==a){d.bindStore(a)}if(b){d.initColumns()}if(a){a.getFilters().endUpdate()}d.reconfiguring=false}});